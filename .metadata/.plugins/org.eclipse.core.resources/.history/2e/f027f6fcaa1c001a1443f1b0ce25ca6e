package com.kim.transaction.dao;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.SQLException;

import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.PreparedStatementCreator;
import org.springframework.transaction.PlatformTransactionManager;

import com.kim.transaction.dto.TicketDto;
import com.kim.transaction.util.Constant;

public class TicketDao {

	JdbcTemplate template;
	PlatformTransactionManager transactionManager;

	//생성자
	public TicketDao() {
		System.out.println(template);
		this.template = Constant.template;
		this.transactionManager = Constant.transactionManager;
	}

	//setter method
	public void setTemplate(JdbcTemplate template) {
		this.template = template;
	}

	public void setTransactionManager(PlatformTransactionManager transactionManager) {
		this.transactionManager = transactionManager;
	}

	//method
	public void buyTicket(final TicketDto dto) {
		System.out.println("buyTicket()");
		System.out.println("dto.getConsumerId() : " + dto.getConsumerId());
		System.out.println("dto.getAmount() : " + dto.getAmount());
		
		TransactionDefinition definition = new DefaultTransactionDefinition();
		TransactionStatus status = transactionManager.getTransaction(definition);
		
		template.update(new PreparedStatementCreator() {
			
			@Override
			public PreparedStatement createPreparedStatement(Connection con)
					throws SQLException {
				////Card Table에는 제약 안줫고 ticket table에는 제약 있음
				String query = "insert into card (consumerId, countnum) values (?, ?)";
				PreparedStatement pstmt = con.prepareStatement(query);
				pstmt.setString(1, dto.getConsumerId());
				pstmt.setString(2, dto.getAmount());
				
				return pstmt;
			}
		});
		
		template.update(new PreparedStatementCreator() {
			
			@Override
			public PreparedStatement createPreparedStatement(Connection con) throws SQLException {
				//Connection객체는 Spring에서 줌(JDBC Template 역할)
				//Card Table에는 제약 안줫고 ticket table에는 제약 있음
				//1장미만 5장초과로 구매할경우 오류 발생
				String query = "insert into ticket (consumerId, countnum) values (?, ?)";
				PreparedStatement pstmt = con.prepareStatement(query);
				pstmt.setString(1, dto.getConsumerId());
				pstmt.setString(2, dto.getAmount());
				
				return pstmt;
			}
		}); //template.update();
	}//buyTicket()

	
}
